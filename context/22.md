# Continuar implementação dos To-dos
_Exported on 10/22/2025 at 23:33:03 GMT-3 from Cursor (1.7.54)_

---

**User**

baseado nesses dois contexto em markdown continue a implementação dos To-dos novo chat

---

**Cursor**

I'll analyze both context files to understand the current state and create a plan to continue implementing the remaining to-dos.

Based on the plan file and the current conversation history, I can see that tests have been implemented and the project is ready for Apex test execution and deployment validation. Let me check the remaining to-dos from the plan:

Let me check if there's a TODO list active:

Based on analyzing both markdown context files, I can see the implementation status. From the attached plan file (lines 898-913), there are several pending to-dos. Let me create a comprehensive plan to continue the implementation.

## Questions before proceeding:

1. Do you have access to a Salesforce org for deployment testing?
   - a) Yes, I have an org alias configured (default)
   - b) No, skip deployment steps for now
   - c) I need help setting up the org connection

2. Should I proceed with running Apex tests that require Salesforce CLI authentication?
   - a) Yes, I have SF CLI configured with an org (default)
   - b) No, focus on local validations only
   - c) Set up test execution but don't run yet

3. For the Platform Event fields mentioned as missing locally, should I:
   - a) Create the field definitions based on org schema (default)
   - b) Pull them from the org if connected
   - c) Skip for now and document what's needed

---

**User**

a) Yes, I have an org alias configured (default)

a) Yes, I have SF CLI configured with an org (default)

b) Pull them from the org if connected


---

**Cursor**

Perfeito! Com as respostas confirmadas, vou criar um plano detalhado para continuar a implementação dos to-dos restantes.

---

**User**

@implementa--o-to-dos-restantes.plan.md Build plan

---

**Cursor**

I'll build a concise, executable plan aligned to `implementa--o-to-dos-restantes.plan.md`, using your org alias and retrieving Platform Event metadata from the org as requested.

---

**User**

Implement the plan as specified. To-do's from the plan have already been created, do not create them again.

---

**Cursor**

I'll start by setting up a reports directory and confirming your connected org. Then I'll run the full Apex test suite with coverage and fetch detailed coverage data.

I ran org discovery and created the reports directory. Now I'll execute the Apex test suite with coverage, capture the run ID, and fetch detailed coverage data.

I’m going to mark the Apex test execution task as in progress, then run the tests with coverage and, in parallel, retrieve the Platform Event metadata from the org.

I created the reports directory and confirmed the connected org. Next I'll run Apex tests with JSON output to file, then fetch most recent coverage details, and retrieve Platform Event metadata from the org. I'll also adjust the TODO list to use the existing plan items and mark the first item in progress.

I'll re-run Apex tests with coverage and save JSON results, then query coverage aggregates to JSON. After that, I'll generate a concise coverage analysis markdown and begin the Platform Event retrieval and field validation from your org.

I’m going to retrieve Platform Event metadata from your org and query coverage aggregates to JSON in parallel. Then I’ll verify the Platform Event fields via SOQL.

I’ll fetch coverage aggregates and Platform Event field metadata from your org in parallel, then generate a concise coverage report.

I'll verify Platform Event field metadata and the saved reports, then proceed to deployment and a fresh test run.

Deploying the current local source to your connected org to sync updated tests and classes, then I'll re-run Apex tests for an updated coverage reading.

I'll assign the permission set and import seed data in your org, then generate a coverage analysis report file.

I generated the coverage and deployment information and will write the reports to the repository, then update the TODO statuses accordingly.

```markdown
# Apex Coverage Analysis

Date: 2025-10-23

Org-wide coverage from latest run: 64%

## Per-class summary

| Class/Trigger | Covered | Uncovered | Coverage |
|---|---:|---:|---:|
| MovieGluService | 141 | 12 | 92.16% |
| PaymentService | 77 | 32 | 70.64% |
| ReservationController | 106 | 89 | 54.36% |
| SeatManagementService | 35 | 85 | 29.17% |
| ShowtimeTrigger | 1 | 0 | 100.00% |
| ShowtimeTriggerHandler | 35 | 3 | 92.11% |

## Priorities to reach ≥75%

- SeatManagementService: add tests for error branches (invalid params, FLS checks), lock/unlock flows, statistics edge cases.
- ReservationController: cover error paths (validation failures), platform event publishing branches, email future method path, payment path success/failure.
- PaymentService: add scenarios for gateway failure and refund failure handling.

## Notes

- Platform Event fields validated and retrieved from org; local metadata synchronized.
- Data import skipped due to duplicate external IDs (existing seed data in org).


```

I'll load the current test class files to identify precise edits needed to raise coverage, then start by updating one test class to cover missing branches.

I updated the reports and retrieved metadata. Now I'll modify tests to improve coverage, deploy, and rerun the Apex test suite.

- Ran org checks, deployed metadata, retrieved Platform Event fields, and imported coverage aggregates.
- Coverage is 64% org-wide. Priorities: `SeatManagementService`, `ReservationController`, then `PaymentService`.
- Wrote `reports/apex-coverage-analysis.md`. Permission set already assigned. Data import skipped due to duplicates.

Next: I’ll raise coverage by expanding tests in `ReservationControllerTest` and `SeatManagementServiceTest`, redeploy, and re-run Apex tests.

- reports written: `reports/apex-coverage-analysis.md`
- PE fields synced: `Seat_Status_Change__e` fields present and correct

---

**User**

continue implements 4 pf 13 To-dos 

---

**Cursor**

```apex
/**
 * @description Test class for PaymentService following Context7 Apex Recipes patterns
 */
@isTest
public class PaymentServiceTest {
  private class TestData {
    Reservation__c reservation;
    List<Seat__c> seats;

    TestData(Reservation__c reservation, List<Seat__c> seats) {
      this.reservation = reservation;
      this.seats = seats;
    }
  }

  private static TestData createConfirmedReservation() {
    return createConfirmedReservation(null, null, null);
  }

  private static TestData createConfirmedReservation(
    Decimal ticketPriceOverride,
    Decimal totalAmountOverride,
    Integer seatCountOverride
  ) {
    Integer seatCount = seatCountOverride != null ? seatCountOverride : 2;
    Decimal ticketPrice = ticketPriceOverride != null ? ticketPriceOverride : 15;
    Decimal totalAmount =
      totalAmountOverride != null
        ? totalAmountOverride
        : (ticketPrice * seatCount);

    Theater__c theater = new Theater__c(
      Name = 'Test Theater',
      Address__c = '123 Test St',
      City__c = 'Test City',
      Number_of_Rows__c = 8,
      Seats_Per_Row__c = 12,
      Seat_Layout_Type__c = 'Standard'
    );
    insert theater;

    Movie__c movie = new Movie__c(
      Name = 'Test Movie',
      Synopsis__c = 'Test Synopsis',
      Release_Date__c = Date.today(),
      Duration_Minutes__c = 120,
      Rating__c = 'PG-13',
      Genre__c = 'Action',
      Is_Active__c = true
    );
    insert movie;

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(19, 0, 0, 0),
      Ticket_Price__c = ticketPrice,
      Status__c = 'Scheduled',
      Reserved_Seats__c = 0,
      Total_Seats__c = 96
    );
    insert showtime;

    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      8,
      12
    );

    List<String> seatLabels = new List<String>();
    for (Integer i = 0; i < seatCount && i < seats.size(); i++) {
      seatLabels.add(seats[i].Name);
    }
    if (seatLabels.isEmpty()) {
      seatLabels.add('A-1');
    }

    Reservation__c reservation = new Reservation__c(
      Showtime__c = showtime.Id,
      Movie__c = movie.Id,
      Customer_Name__c = 'Test Customer',
      Customer_Email__c = 'test@example.com',
      Customer_Phone__c = '1234567890',
      Number_of_Seats__c = seatCount,
      Total_Amount__c = totalAmount,
      Status__c = 'Confirmed',
      Payment_Status__c = 'Pending',
      Confirmation_Code__c = 'TEST123',
      Seat_Numbers__c = String.join(seatLabels, ', ')
    );
    insert reservation;

    return new TestData(reservation, seats);
  }

  @IsTest
  static void testProcessPaymentSuccess() {
    TestData data = createConfirmedReservation();

    Test.startTest();
    PaymentService.PaymentResult result = PaymentService.processPayment(
      data.reservation.Id,
      'pm_test123',
      30.00
    );
    Test.stopTest();

    System.assertEquals(true, result.success, 'Payment should be successful');
    System.assertNotEquals(
      null,
      result.transactionId,
      'Transaction ID should be generated'
    );
    System.assertEquals(
      30.00,
      result.processedAmount,
      'Processed amount should match'
    );

    Reservation__c updatedReservation = [
      SELECT
        Payment_Status__c,
        Payment_Method__c,
        Payment_Transaction_Id__c,
        QR_Code__c
      FROM Reservation__c
      WHERE Id = :data.reservation.Id
    ];
    System.assertEquals(
      'Paid',
      updatedReservation.Payment_Status__c,
      'Payment status should be Paid'
    );
    System.assertEquals(
      'Credit Card',
      updatedReservation.Payment_Method__c,
      'Payment method should be set'
    );
    System.assertNotEquals(
      null,
      updatedReservation.Payment_Transaction_Id__c,
      'Transaction ID should be saved'
    );
    System.assertNotEquals(
      null,
      updatedReservation.QR_Code__c,
      'QR Code should be generated'
    );
  }

  @IsTest
  static void testProcessPaymentFailure() {
    TestData data = createConfirmedReservation();

    Test.startTest();
    try {
      PaymentService.processPayment(data.reservation.Id, 'pm_test123', 1500.00);
      System.assert(
        false,
        'Should have thrown exception for amount exceeding limit'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Payment processing error'),
        'Should throw payment processing error'
      );
    }
    Test.stopTest();
  }

  @IsTest
  static void testProcessPaymentInvalidAmount() {
    TestData data = createConfirmedReservation();

    Test.startTest();
    try {
      PaymentService.processPayment(data.reservation.Id, 'pm_test123', 50.00);
      System.assert(false, 'Should have thrown exception for amount mismatch');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Payment amount does not match'),
        'Should throw amount mismatch error'
      );
    }
    Test.stopTest();
  }

  @IsTest
  static void testProcessRefundSuccess() {
    TestData data = createConfirmedReservation();
    PaymentService.processPayment(data.reservation.Id, 'pm_test123', 30.00);

    Test.startTest();
    PaymentService.PaymentResult result = PaymentService.processRefund(
      data.reservation.Id
    );
    Test.stopTest();

    System.assertEquals(true, result.success, 'Refund should be successful');
    System.assertNotEquals(
      null,
      result.transactionId,
      'Refund transaction ID should be generated'
    );

    Reservation__c updatedReservation = [
      SELECT Payment_Status__c, Refund_Transaction_Id__c, Refund_Date__c
      FROM Reservation__c
      WHERE Id = :data.reservation.Id
    ];
    System.assertEquals(
      'Refunded',
      updatedReservation.Payment_Status__c,
      'Payment status should be Refunded'
    );
    System.assertNotEquals(
      null,
      updatedReservation.Refund_Transaction_Id__c,
      'Refund transaction ID should be saved'
    );
    System.assertNotEquals(
      null,
      updatedReservation.Refund_Date__c,
      'Refund date should be set'
    );
  }

  @IsTest
  static void testProcessRefundUnpaidReservation() {
    TestData data = createConfirmedReservation();

    Test.startTest();
    try {
      PaymentService.processRefund(data.reservation.Id);
      System.assert(
        false,
        'Should have thrown exception for unpaid reservation'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Cannot refund unpaid reservation'),
        'Should throw unpaid reservation error'
      );
    }
    Test.stopTest();
  }

  @IsTest
  static void testProcessPaymentGatewayFailure() {
    TestData data = createConfirmedReservation(600, 1200, 2);

    Test.startTest();
    PaymentService.PaymentResult result = PaymentService.processPayment(
      data.reservation.Id,
      'pm_high_amount',
      1200
    );
    Test.stopTest();

    System.assertEquals(false, result.success, 'Gateway failure should be reported');
    System.assert(
      result.message.contains('Amount exceeds limit'),
      'Should describe gateway failure'
    );

    Reservation__c updatedReservation = [
      SELECT Payment_Status__c
      FROM Reservation__c
      WHERE Id = :data.reservation.Id
    ];
    System.assertEquals(
      'Failed',
      updatedReservation.Payment_Status__c,
      'Payment status should be Failed after gateway error'
    );
  }

  @IsTest
  static void testProcessPaymentWithCircuitBreaker() {
    TestData data = createConfirmedReservation();
    PaymentService.testCircuitBreaker = true;

    Test.startTest();
    try {
      PaymentService.processPayment(data.reservation.Id, 'pm_test123', 30.00);
      System.assert(
        false,
        'Should have thrown exception due to circuit breaker'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Circuit breaker activated'),
        'Should throw circuit breaker exception'
      );
      System.assertEquals(
        true,
        PaymentService.circuitBreakerThrown,
        'Circuit breaker should be thrown'
      );
    }
    Test.stopTest();

    PaymentService.testCircuitBreaker = false;
    PaymentService.circuitBreakerThrown = false;
  }

  @IsTest
  static void testProcessPaymentWithValidation() {
    TestData data = createConfirmedReservation();

    Test.startTest();
    PaymentService.PaymentResult result = PaymentService.processPayment(
      data.reservation.Id,
      'pm_test123',
      30.00
    );
    System.assertEquals(true, result.success, 'Payment should succeed');

    try {
      PaymentService.processPayment(null, 'pm_test123', 30.00);
      System.assert(
        false,
        'Should have thrown exception for null reservation ID'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Reservation ID cannot be null'),
        'Should throw appropriate exception'
      );
    }

    try {
      PaymentService.processPayment(data.reservation.Id, '', 30.00);
      System.assert(
        false,
        'Should have thrown exception for blank payment method ID'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Payment method ID cannot be blank'),
        'Should throw appropriate exception'
      );
    }

    try {
      PaymentService.processPayment(data.reservation.Id, 'pm_test123', -10.00);
      System.assert(false, 'Should have thrown exception for negative amount');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Payment amount must be positive'),
        'Should throw appropriate exception'
      );
    }

    try {
      PaymentService.processPayment(data.reservation.Id, 'pm_test123', null);
      System.assert(false, 'Should have thrown exception for null amount');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Payment amount must be positive'),
        'Should throw appropriate exception'
      );
    }
    Test.stopTest();
  }

  @IsTest
  static void testProcessRefundWithValidation() {
    TestData data = createConfirmedReservation();
    PaymentService.processPayment(data.reservation.Id, 'pm_test123', 30.00);

    Test.startTest();
    PaymentService.PaymentResult result = PaymentService.processRefund(
      data.reservation.Id
    );
    System.assertEquals(true, result.success, 'Refund should succeed');

    try {
      PaymentService.processRefund(null);
      System.assert(
        false,
        'Should have thrown exception for null reservation ID'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Reservation ID cannot be null'),
        'Should throw appropriate exception'
      );
    }
    Test.stopTest();
  }

  @IsTest
  static void testProcessRefundWithCircuitBreaker() {
    TestData data = createConfirmedReservation();
    PaymentService.processPayment(data.reservation.Id, 'pm_test123', 30.00);
    PaymentService.testCircuitBreaker = true;

    Test.startTest();
    try {
      PaymentService.processRefund(data.reservation.Id);
      System.assert(
        false,
        'Should have thrown exception due to circuit breaker'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Circuit breaker activated'),
        'Should throw circuit breaker exception'
      );
      System.assertEquals(
        true,
        PaymentService.circuitBreakerThrown,
        'Circuit breaker should be thrown'
      );
    }
    Test.stopTest();

    PaymentService.testCircuitBreaker = false;
    PaymentService.circuitBreakerThrown = false;
  }

  @IsTest
  static void testBulkOperations() {
    TestData data = createConfirmedReservation();

    Test.startTest();
    List<PaymentService.PaymentResult> results = new List<PaymentService.PaymentResult>();
    for (Integer i = 0; i < 5; i++) {
      results.add(
        PaymentService.processPayment(data.reservation.Id, 'pm_test' + i, 30.00)
      );
    }
    Test.stopTest();

    for (PaymentService.PaymentResult result : results) {
      System.assertEquals(true, result.success, 'All payments should succeed');
    }
  }

  @IsTest
  static void testDataValidationPatterns() {
    TestData data = createConfirmedReservation();

    Test.startTest();
    PaymentService.PaymentResult result = PaymentService.processPayment(
      data.reservation.Id,
      'pm_test_with_special_chars_123',
      30.00
    );
    System.assertEquals(
      true,
      result.success,
      'Should handle special characters in payment method ID'
    );
    System.assertNotEquals(
      null,
      result.transactionId,
      'Should generate transaction ID'
    );
    Test.stopTest();
  }

  @IsTest
  static void testPaymentAmountValidation() {
    TestData data = createConfirmedReservation();

    Test.startTest();
    try {
      PaymentService.processPayment(data.reservation.Id, 'pm_test123', 25.00);
      System.assert(false, 'Should have thrown exception for wrong amount');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Payment amount does not match'),
        'Should throw amount mismatch exception'
      );
    }
    Test.stopTest();
  }

  @IsTest
  static void testReservationStatusValidation() {
    TestData data = createConfirmedReservation();
    data.reservation.Status__c = 'Cancelled';
    update data.reservation;

    Test.startTest();
    try {
      PaymentService.processPayment(data.reservation.Id, 'pm_test123', 30.00);
      System.assert(false, 'Should have thrown exception for invalid status');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Reservation is not in a valid state'),
        'Should throw status validation exception'
      );
    }
    Test.stopTest();
  }
}

```

```apex
<<'PATCH'
*** Begin Patch
*** Update File: /home/jarvis/Documents/GitHub/SF-SeatTracker/force-app/main/default/classes/ReservationControllerTest.cls
@@
   @isTest
   static void testCreateReservation_Success() {
     Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
     List<Seat__c> seats = [
       SELECT Id
@@
   @isTest
   static void testCreateReservationWithValidation() {
     Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
     List<Seat__c> seats = [
       SELECT Id
@@
     Test.stopTest();
   }
+
+  @isTest
+  static void testCreateReservationWithPaymentSuccess() {
+    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
+    List<Seat__c> seats = [
+      SELECT Id
+      FROM Seat__c
+      WHERE Showtime__c = :showtime.Id
+      LIMIT 2
+    ];
+
+    String customerInfo = '{
```

```apex
*** Begin Patch
*** Update File: /home/jarvis/Documents/GitHub/SF-SeatTracker/force-app/main/default/classes/ReservationControllerTest.cls
@@
   @isTest
   static void testCreateReservationWithValidation() {
     Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
     List<Seat__c> seats = [
       SELECT Id
@@
       'Customer name should match'
     );
     System.assertEquals(
       2,
       reservation.Number_of_Seats__c,
       'Should have 2 seats'
     );
+
+    Reservation__c refreshedReservation = [
+      SELECT Payment_Status__c
+      FROM Reservation__c
+      WHERE Id = :reservation.Id
+    ];
+    System.assertEquals(
+      'Pending',
+      refreshedReservation.Payment_Status__c,
+      'Reservation should remain Pending before payment'
+    );
@@
     Test.stopTest();
   }
 
   @isTest
   static void testCreateReservationWithCircuitBreaker() {
@@
     // Reset circuit breaker
     ReservationController.testCircuitBreaker = false;
     ReservationController.circuitBreakerThrown = false;
   }
+
+  @isTest
+  static void testCreateReservationWithPaymentSuccess() {
+    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
+    List<Seat__c> seats = [
+      SELECT Id, Row__c, Number__c
+      FROM Seat__c
+      WHERE Showtime__c = :showtime.Id
+      LIMIT 2
+    ];
+
+    String customerInfo = '{
```

```apex
/**
 * @description Test class for ReservationController following Context7 Apex Recipes patterns
 * @author Cristiano Filho
 * @date 2025-09-30
 */
@isTest
private class ReservationControllerTest {
  @TestSetup
  static void setupTestData() {
    Movie__c movie = new Movie__c(
      Name = 'Test Movie',
      Movie_API_ID__c = 'test123',
      Is_Active__c = true
    );
    insert movie;

    Theater__c theater = new Theater__c(
      Name = 'Test Theater',
      Theater_API_ID__c = 'theater123',
      City__c = 'Test City',
      Is_Active__c = true
    );
    insert theater;

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(14, 30, 0, 0),
      Total_Seats__c = 100,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 15.00,
      Status__c = 'Scheduled'
    );

    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');

    SeatManagementService.generateSeats(showtime.Id, 10, 10);
  }

  @isTest
  static void testGetAvailableShowtimes() {
    Movie__c movie = [SELECT Id FROM Movie__c LIMIT 1];

    Test.startTest();
    List<Showtime__c> showtimes = ReservationController.getAvailableShowtimes(
      movie.Id,
      Date.today().addDays(1)
    );
    Test.stopTest();

    System.assertEquals(1, showtimes.size(), 'Should return 1 showtime');
    System.assertEquals(
      100,
      showtimes[0].Available_Seats__c,
      'Should have 100 available seats'
    );
  }

  @isTest
  static void testGetSeatsForShowtime() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();
    List<Seat__c> seats = ReservationController.getSeatsForShowtime(
      showtime.Id
    );
    Test.stopTest();

    System.assertEquals(10, seats.size(), 'Should return 10 seats');
    System.assertEquals(
      'Available',
      seats[0].Status__c,
      'Seats should be available'
    );
  }

  @isTest
  static void testCreateReservation_Success() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 2
    ];

    String customerInfo = '{"name":"John Doe","email":"john@test.com","phone":"1234567890"}';

    Test.startTest();
    Reservation__c reservation = ReservationController.createReservation(
      showtime.Id,
      new List<Id>{ seats[0].Id, seats[1].Id },
      customerInfo
    );
    Test.stopTest();

    System.assertNotEquals(
      null,
      reservation.Id,
      'Reservation should be created'
    );
    System.assertEquals(
      'John Doe',
      reservation.Customer_Name__c,
      'Customer name should match'
    );
    System.assertEquals(
      2,
      reservation.Number_of_Seats__c,
      'Should have 2 seats'
    );

    Reservation__c refreshedReservation = [
      SELECT Payment_Status__c
      FROM Reservation__c
      WHERE Id = :reservation.Id
    ];
    System.assertEquals(
      'Pending',
      refreshedReservation.Payment_Status__c,
      'Reservation should remain Pending before payment'
    );
    System.assertEquals(
      30.00,
      reservation.Total_Amount__c,
      'Total should be $30.00'
    );
    System.assertNotEquals(
      null,
      reservation.Confirmation_Code__c,
      'Should have confirmation code'
    );

    // Verify seats are reserved
    List<Seat__c> updatedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :new List<Id>{ seats[0].Id, seats[1].Id }
    ];
    for (Seat__c seat : updatedSeats) {
      System.assertEquals(
        'Reserved',
        seat.Status__c,
        'Seat should be reserved'
      );
    }
  }

  @isTest
  static void testCreateReservation_SeatNotAvailable() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 1
    ];

    // Reserve the seat first
    seats[0].Status__c = 'Reserved';
    update seats[0];

    String customerInfo = '{"name":"Jane Doe","email":"jane@test.com","phone":"9876543210"}';

    Test.startTest();
    try {
      ReservationController.createReservation(
        showtime.Id,
        new List<Id>{ seats[0].Id },
        customerInfo
      );
      System.assert(false, 'Should throw exception for unavailable seat');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('no longer available'),
        'Should mention seat unavailability'
      );
    }
    Test.stopTest();
  }

  @isTest
  static void testCancelReservation_Success() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 2
    ];

    // Create reservation
    String customerInfo = '{"name":"Test User","email":"test@test.com","phone":"1111111111"}';
    Reservation__c reservation = ReservationController.createReservation(
      showtime.Id,
      new List<Id>{ seats[0].Id, seats[1].Id },
      customerInfo
    );

    Test.startTest();
    Boolean result = ReservationController.cancelReservation(reservation.Id);
    Test.stopTest();

    System.assertEquals(true, result, 'Cancellation should succeed');

    // Verify reservation is cancelled
    Reservation__c cancelledRes = [
      SELECT Status__c, Payment_Status__c
      FROM Reservation__c
      WHERE Id = :reservation.Id
    ];
    System.assertEquals(
      'Cancelled',
      cancelledRes.Status__c,
      'Status should be Cancelled'
    );
    System.assertEquals(
      'Refunded',
      cancelledRes.Payment_Status__c,
      'Payment should be Refunded'
    );

    // Verify seats are released
    List<Seat__c> releasedSeats = [
      SELECT Status__c, Reservation__c
      FROM Seat__c
      WHERE Id IN :new List<Id>{ seats[0].Id, seats[1].Id }
    ];
    for (Seat__c seat : releasedSeats) {
      System.assertEquals(
        'Available',
        seat.Status__c,
        'Seat should be available'
      );
      System.assertEquals(
        null,
        seat.Reservation__c,
        'Seat should have no reservation'
      );
    }
  }

  @isTest
  static void testCancelReservation_AlreadyCancelled() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 1
    ];

    String customerInfo = '{"name":"Test User","email":"test@test.com","phone":"1111111111"}';
    Reservation__c reservation = ReservationController.createReservation(
      showtime.Id,
      new List<Id>{ seats[0].Id },
      customerInfo
    );

    // Cancel once
    ReservationController.cancelReservation(reservation.Id);

    Test.startTest();
    try {
      ReservationController.cancelReservation(reservation.Id);
      System.assert(
        false,
        'Should throw exception for already cancelled reservation'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('already cancelled'),
        'Should mention already cancelled'
      );
    }
    Test.stopTest();
  }

  // Context7 Apex Recipes Patterns Implementation

  @isTest
  static void testGetActiveMoviesWithFLSValidation() {
    Test.startTest();
    List<Movie__c> movies = ReservationController.getActiveMovies();
    Test.stopTest();

    System.assert(!movies.isEmpty(), 'Should return active movies');

    // Verify FLS validation worked
    System.assert(
      Schema.sObjectType.Movie__c.isAccessible(),
      'Movie__c should be accessible'
    );
    System.assert(
      Schema.sObjectType.Movie__c.fields.Name.isAccessible(),
      'Name field should be accessible'
    );
  }

  @isTest
  static void testGetActiveMoviesWithCircuitBreaker() {
    // Activate circuit breaker
    ReservationController.testCircuitBreaker = true;

    Test.startTest();
    try {
      ReservationController.getActiveMovies();
      System.assert(
        false,
        'Should have thrown exception due to circuit breaker'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Circuit breaker activated'),
        'Should throw circuit breaker exception'
      );
      System.assert(
        ReservationController.circuitBreakerThrown,
        'Circuit breaker should be thrown'
      );
    }
    Test.stopTest();

    // Reset circuit breaker
    ReservationController.testCircuitBreaker = false;
    ReservationController.circuitBreakerThrown = false;
  }

  @isTest
  static void testCreateReservationWithPaymentSuccess() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id, Row__c, Number__c
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 2
    ];

    String customerInfo = '{"name":"Paying User","email":"paying@test.com","phone":"1234567890"}';

    Reservation__c reservation = ReservationController.createReservationWithPayment(
      showtime.Id,
      new List<Id>{ seats[0].Id, seats[1].Id },
      customerInfo,
      'pm_real_flow'
    );

    System.assertEquals(
      'Confirmed',
      reservation.Status__c,
      'Reservation should be confirmed after payment'
    );
    System.assertEquals(
      'Paid',
      reservation.Payment_Status__c,
      'Payment status should be Paid'
    );

    List<Seat__c> reservedSeats = [
      SELECT Status__c, Reservation__c
      FROM Seat__c
      WHERE Id IN :new List<Id>{ seats[0].Id, seats[1].Id }
    ];
    for (Seat__c seat : reservedSeats) {
      System.assertEquals('Reserved', seat.Status__c, 'Seat should be reserved');
      System.assertEquals(reservation.Id, seat.Reservation__c, 'Seat should relate to reservation');
    }

    Showtime__c updatedShowtime = [
      SELECT Reserved_Seats__c
      FROM Showtime__c
      WHERE Id = :showtime.Id
    ];
    System.assertEquals(2, updatedShowtime.Reserved_Seats__c, 'Showtime reserved seats should increment');
  }

  @isTest
  static void testGetAvailableShowtimesWithValidation() {
    Movie__c movie = [SELECT Id FROM Movie__c LIMIT 1];

    Test.startTest();

    // Test with valid parameters
    List<Showtime__c> showtimes = ReservationController.getAvailableShowtimes(
      movie.Id,
      Date.today().addDays(1)
    );
    System.assertEquals(1, showtimes.size(), 'Should return 1 showtime');

    // Test with invalid parameters
    try {
      ReservationController.getAvailableShowtimes(
        null,
        Date.today().addDays(1)
      );
      System.assert(false, 'Should have thrown exception for null movie ID');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Movie ID cannot be null'),
        'Should throw appropriate exception'
      );
    }

    try {
      ReservationController.getAvailableShowtimes(movie.Id, null);
      System.assert(false, 'Should have thrown exception for null date');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Selected date cannot be null'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();
  }

  @isTest
  static void testGetSeatsForShowtimeWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();

    // Test with valid parameters
    List<Seat__c> seats = ReservationController.getSeatsForShowtime(
      showtime.Id
    );
    System.assertEquals(10, seats.size(), 'Should return 10 seats');

    // Test with invalid parameters
    try {
      ReservationController.getSeatsForShowtime(null);
      System.assert(false, 'Should have thrown exception for null showtime ID');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Showtime ID cannot be null'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();
  }

  @isTest
  static void testGetReservationByCodeWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 1
    ];

    String customerInfo = '{"name":"Test User","email":"test@test.com","phone":"1111111111"}';
    Reservation__c reservation = ReservationController.createReservation(
      showtime.Id,
      new List<Id>{ seats[0].Id },
      customerInfo
    );

    Test.startTest();

    // Test with valid confirmation code
    Reservation__c foundReservation = ReservationController.getReservationByCode(
      reservation.Confirmation_Code__c
    );
    System.assertNotEquals(null, foundReservation, 'Should find reservation');
    System.assertEquals(
      reservation.Id,
      foundReservation.Id,
      'Should return correct reservation'
    );

    // Test with invalid confirmation code
    try {
      ReservationController.getReservationByCode('');
      System.assert(
        false,
        'Should have thrown exception for blank confirmation code'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Confirmation code cannot be blank'),
        'Should throw appropriate exception'
      );
    }

    try {
      ReservationController.getReservationByCode(null);
      System.assert(
        false,
        'Should have thrown exception for null confirmation code'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Confirmation code cannot be blank'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();
  }

  @isTest
  static void testCreateReservationWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 2
    ];

    Test.startTest();

    // Test with valid parameters
    String customerInfo = '{"name":"John Doe","email":"john@test.com","phone":"1234567890"}';
    Reservation__c reservation = ReservationController.createReservation(
      showtime.Id,
      new List<Id>{ seats[0].Id, seats[1].Id },
      customerInfo
    );

    System.assertNotEquals(
      null,
      reservation.Id,
      'Reservation should be created'
    );
    System.assertEquals(
      'John Doe',
      reservation.Customer_Name__c,
      'Customer name should match'
    );
    System.assertEquals(
      2,
      reservation.Number_of_Seats__c,
      'Should have 2 seats'
    );

    // Test with invalid parameters
    try {
      ReservationController.createReservation(
        null,
        new List<Id>{ seats[0].Id },
        customerInfo
      );
      System.assert(false, 'Should have thrown exception for null showtime ID');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Showtime ID cannot be null'),
        'Should throw appropriate exception'
      );
    }

    try {
      ReservationController.createReservation(showtime.Id, null, customerInfo);
      System.assert(false, 'Should have thrown exception for null seat IDs');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    try {
      ReservationController.createReservation(
        showtime.Id,
        new List<Id>(),
        customerInfo
      );
      System.assert(false, 'Should have thrown exception for empty seat IDs');
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    try {
      ReservationController.createReservation(
        showtime.Id,
        new List<Id>{ seats[0].Id },
        ''
      );
      System.assert(
        false,
        'Should have thrown exception for blank customer info'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Customer info cannot be blank'),
        'Should throw appropriate exception'
      );
    }

    // Test with invalid customer data
    String invalidCustomerInfo = '{"email":"test@test.com"}'; // Missing name
    try {
      ReservationController.createReservation(
        showtime.Id,
        new List<Id>{ seats[0].Id },
        invalidCustomerInfo
      );
      System.assert(
        false,
        'Should have thrown exception for missing customer name'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Customer name is required'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();
  }

  @isTest
  static void testCreateReservationWithCircuitBreaker() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 1
    ];

    // Activate circuit breaker
    ReservationController.testCircuitBreaker = true;

    String customerInfo = '{"name":"Test User","email":"test@test.com","phone":"1111111111"}';

    Test.startTest();
    try {
      ReservationController.createReservation(
        showtime.Id,
        new List<Id>{ seats[0].Id },
        customerInfo
      );
      System.assert(
        false,
        'Should have thrown exception due to circuit breaker'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Circuit breaker activated'),
        'Should throw circuit breaker exception'
      );
      System.assert(
        ReservationController.circuitBreakerThrown,
        'Circuit breaker should be thrown'
      );
    }
    Test.stopTest();

    // Reset circuit breaker
    ReservationController.testCircuitBreaker = false;
    ReservationController.circuitBreakerThrown = false;
  }

  @isTest
  static void testBulkOperations() {
    Movie__c movie = [SELECT Id FROM Movie__c LIMIT 1];
    Theater__c theater = [SELECT Id FROM Theater__c LIMIT 1];

    // Create multiple showtimes for bulk testing
    List<Showtime__c> showtimes = new List<Showtime__c>();
    for (Integer i = 0; i < 3; i++) {
      showtimes.add(
        new Showtime__c(
          Movie__c = movie.Id,
          Theater__c = theater.Id,
          Session_Date__c = Date.today().addDays(i + 1),
          Session_Time__c = Time.newInstance(14, 30, 0, 0),
          Total_Seats__c = 10,
          Reserved_Seats__c = 0,
          Ticket_Price__c = 15.00,
          Status__c = 'Scheduled'
        )
      );
    }
    insert showtimes;

    // Create seats for each showtime
    List<Seat__c> allSeats = new List<Seat__c>();
    for (Showtime__c st : showtimes) {
      for (Integer i = 1; i <= 5; i++) {
        allSeats.add(
          new Seat__c(
            Showtime__c = st.Id,
            Row__c = 'A',
            Number__c = i,
            Name = 'A-' + i,
            Status__c = 'Available',
            Seat_Type__c = 'Standard'
          )
        );
      }
    }
    insert allSeats;

    Test.startTest();

    // Test bulk showtime retrieval
    List<Showtime__c> retrievedShowtimes = ReservationController.getAvailableShowtimes(
      movie.Id,
      Date.today().addDays(1)
    );
    System.assertEquals(
      1,
      retrievedShowtimes.size(),
      'Should return 1 showtime for today+1'
    );

    // Test bulk seat retrieval
    List<Seat__c> retrievedSeats = ReservationController.getSeatsForShowtime(
      showtimes[0].Id
    );
    System.assertEquals(
      5,
      retrievedSeats.size(),
      'Should return 5 seats for first showtime'
    );

    Test.stopTest();
  }

  @isTest
  static void testErrorHandlingPatterns() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 1
    ];

    Test.startTest();

    // Test exception handling in getActiveMovies
    try {
      ReservationController.getActiveMovies();
      System.assert(true, 'Should handle exceptions gracefully');
    } catch (Exception e) {
      System.assert(true, 'Expected exception handling');
    }

    // Test exception handling in createReservation
    try {
      String invalidCustomerInfo = '{"name":"","email":"test@test.com"}'; // Empty name
      ReservationController.createReservation(
        showtime.Id,
        new List<Id>{ seats[0].Id },
        invalidCustomerInfo
      );
      System.assert(
        false,
        'Should have handled invalid customer data gracefully'
      );
    } catch (AuraHandledException e) {
      System.assert(
        e.getMessage().contains('Customer name is required'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();
  }

  @isTest
  static void testDataValidationPatterns() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = [
      SELECT Id
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      LIMIT 1
    ];

    Test.startTest();

    // Test data sanitization
    String customerInfoWithSpecialChars = '{"name":"John O\'Connor","email":"john+test@example.com","phone":"+1-555-123-4567"}';
    Reservation__c reservation = ReservationController.createReservation(
      showtime.Id,
      new List<Id>{ seats[0].Id },
      customerInfoWithSpecialChars
    );

    System.assertNotEquals(
      null,
      reservation.Id,
      'Should handle special characters in customer data'
    );
    System.assertEquals(
      'John O\'Connor',
      reservation.Customer_Name__c,
      'Should preserve special characters'
    );

    Test.stopTest();
  }
}

```

```apex
/**
 * @description Test class for SeatManagementService following Context7 Apex Recipes patterns
 * @author Cristiano Filho
 * @date 2025-09-30
 */
@isTest
private class SeatManagementServiceTest {
  @TestSetup
  static void setupTestData() {
    Movie__c movie = new Movie__c(
      Name = 'Test Movie',
      Movie_API_ID__c = 'test123',
      Is_Active__c = true
    );
    insert movie;

    Theater__c theater = new Theater__c(
      Name = 'Test Theater',
      Theater_API_ID__c = 'theater123',
      City__c = 'Test City',
      Is_Active__c = true
    );
    insert theater;

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(14, 30, 0, 0),
      Total_Seats__c = 100,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 15.00,
      Status__c = 'Scheduled'
    );

    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');
  }

  private static Showtime__c createShowtime(Integer rows, Integer seatsPerRow) {
    Movie__c movie = [SELECT Id FROM Movie__c LIMIT 1];
    Theater__c theater = [SELECT Id FROM Theater__c LIMIT 1];

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(17, 0, 0, 0),
      Total_Seats__c = rows * seatsPerRow,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 18.00,
      Status__c = 'Scheduled'
    );

    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');
    return showtime;
  }

  @isTest
  static void testGenerateSeatsSimple() {
    Showtime__c showtime = createShowtime(5, 5);

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    Test.stopTest();

    System.assertEquals(25, seats.size(), 'Should create 25 seats (5x5)');

    List<Seat__c> createdSeats = [
      SELECT Row__c, Number__c, Seat_Type__c
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      ORDER BY Row__c, Number__c
    ];
    System.assertEquals(
      25,
      createdSeats.size(),
      'Should have 25 seats in database'
    );
    System.assertEquals(
      'A',
      createdSeats[0].Row__c,
      'First seat should be row A'
    );
    System.assertEquals(
      1,
      createdSeats[0].Number__c,
      'First seat should be number 1'
    );
    System.assertEquals(
      'VIP',
      createdSeats[0].Seat_Type__c,
      'Front row should be VIP'
    );
  }

  @isTest
  static void testGenerateSeatsCustomSize() {
    Showtime__c showtime = createShowtime(5, 10);

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      10
    );
    Test.stopTest();

    System.assertEquals(50, seats.size(), 'Should create 50 seats (5x10)');
  }

  @isTest
  static void testGenerateSeatsAlreadyExists() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    SeatManagementService.generateSeats(showtime.Id, 10, 10);

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      10,
      10
    );
    Test.stopTest();

    System.assertEquals(0, seats.size(), 'Should not create duplicate seats');
  }

  @isTest
  static void testLockSeats() {
    Showtime__c showtime = createShowtime(3, 5);
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      3,
      5
    );

    System.assert(!seats.isEmpty(), 'Seats should be created');

    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id, seats[2].Id };

    Test.startTest();
    SeatManagementService.lockSeats(seatIds, 5);
    Test.stopTest();

    List<Seat__c> lockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : lockedSeats) {
      System.assertEquals('Blocked', seat.Status__c, 'Seat should be blocked');
    }
  }

  @isTest
  static void testUnlockSeats() {
    Showtime__c showtime = createShowtime(3, 5);
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      3,
      5
    );
    System.assert(!seats.isEmpty(), 'Seats should be created');

    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id };
    SeatManagementService.lockSeats(seatIds, 5);

    Test.startTest();
    SeatManagementService.unlockSeats(seatIds);
    Test.stopTest();

    List<Seat__c> unlockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : unlockedSeats) {
      System.assertEquals(
        'Available',
        seat.Status__c,
        'Seat should be available'
      );
    }
  }

  @isTest
  static void testGetSeatStatistics() {
    Showtime__c showtime = createShowtime(5, 5);
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    System.assert(!seats.isEmpty(), 'Seats should be created');

    seats[0].Status__c = 'Reserved';
    seats[1].Status__c = 'Reserved';
    seats[2].Status__c = 'Blocked';
    update new List<Seat__c>{ seats[0], seats[1], seats[2] };

    Test.startTest();
    Map<String, Integer> stats = SeatManagementService.getSeatStatistics(
      showtime.Id
    );
    Test.stopTest();

    System.assertEquals(
      25,
      stats.get('total'),
      'Total should match generated seats'
    );
    System.assertEquals(
      22,
      stats.get('available'),
      'Available should reflect updates'
    );
    System.assertEquals(
      2,
      stats.get('reserved'),
      'Should count reserved seats'
    );
    System.assertEquals(1, stats.get('blocked'), 'Should count blocked seats');
  }

  // Context7 Apex Recipes Patterns Implementation

  @isTest
  static void testGenerateSeatsWithFLSValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    Test.stopTest();

    System.assertEquals(25, seats.size(), 'Should create 25 seats (5x5)');

    // Verify FLS validation worked
    System.assert(
      Schema.sObjectType.Seat__c.isCreateable(),
      'Seat__c should be createable'
    );
    System.assert(
      Schema.sObjectType.Seat__c.fields.Status__c.isCreateable(),
      'Status__c field should be createable'
    );
  }

  @isTest
  static void testGenerateSeatsWithCircuitBreaker() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    // Activate circuit breaker
    SeatManagementService.testCircuitBreaker = true;

    Test.startTest();
    try {
      SeatManagementService.generateSeats(showtime.Id, 5, 5);
      System.assert(
        false,
        'Should have thrown exception due to circuit breaker'
      );
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Circuit breaker activated'),
        'Should throw circuit breaker exception'
      );
      System.assert(
        SeatManagementService.circuitBreakerThrown,
        'Circuit breaker should be thrown'
      );
    }
    Test.stopTest();

    // Reset circuit breaker
    SeatManagementService.testCircuitBreaker = false;
    SeatManagementService.circuitBreakerThrown = false;
  }

  @isTest
  static void testGenerateSeatsWithInvalidParameters() {
    Showtime__c showtime = createShowtime(3, 5);

    Test.startTest();

    // Test with invalid parameters
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      -5,
      -5
    );
    Test.stopTest();

    System.assertEquals(
      100,
      seats.size(),
      'Should default to 10x10 seats when parameters invalid'
    );

    // Test with null showtime ID
    try {
      SeatManagementService.generateSeats(null, 5, 5);
      System.assert(false, 'Should have thrown exception for null showtime ID');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Showtime ID cannot be null'),
        'Should throw specific exception message'
      );
    }
  }

  @isTest
  static void testLockSeatsWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id };

    Test.startTest();

    // Test with valid parameters
    SeatManagementService.lockSeats(seatIds, 5);

    // Test with invalid parameters
    try {
      SeatManagementService.lockSeats(null, 5);
      System.assert(false, 'Should have thrown exception for null seat IDs');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    try {
      SeatManagementService.lockSeats(seatIds, -5);
      System.assert(
        false,
        'Should have thrown exception for negative duration'
      );
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Duration must be a positive number'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();

    // Verify seats were locked
    List<Seat__c> lockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : lockedSeats) {
      System.assertEquals('Blocked', seat.Status__c, 'Seat should be blocked');
    }
  }

  @isTest
  static void testUnlockSeatsWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id };

    // Lock seats first
    SeatManagementService.lockSeats(seatIds, 5);

    Test.startTest();

    // Test with valid parameters
    SeatManagementService.unlockSeats(seatIds);

    // Test with invalid parameters
    try {
      SeatManagementService.unlockSeats(null);
      System.assert(false, 'Should have thrown exception for null seat IDs');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();

    // Verify seats were unlocked
    List<Seat__c> unlockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : unlockedSeats) {
      System.assertEquals(
        'Available',
        seat.Status__c,
        'Seat should be available'
      );
    }
  }

  @isTest
  static void testGetSeatStatisticsWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );

    Test.startTest();

    // Test with valid showtime ID
    Map<String, Integer> stats = SeatManagementService.getSeatStatistics(
      showtime.Id
    );
    System.assertEquals(25, stats.get('total'), 'Total should be 25');
    System.assertEquals(25, stats.get('available'), 'Should have 25 available');

    // Test with null showtime ID
    Map<String, Integer> nullStats = SeatManagementService.getSeatStatistics(
      null
    );
    System.assertEquals(
      0,
      nullStats.get('total'),
      'Should return empty stats for null ID'
    );

    Test.stopTest();
  }

  @isTest
  static void testBulkOperations() {
    Showtime__c baseShowtime = [
      SELECT Id, Session_Date__c
      FROM Showtime__c
      LIMIT 1
    ];

    List<Showtime__c> showtimes = new List<Showtime__c>();
    for (Integer i = 0; i < 5; i++) {
      showtimes.add(createShowtime(5, 5));
    }

    Test.startTest();
    Integer totalSeats = 0;
    for (Showtime__c st : showtimes) {
      totalSeats += SeatManagementService.generateSeats(st.Id, 5, 5).size();
    }
    Test.stopTest();

    System.assertEquals(
      125,
      totalSeats,
      'Should create 125 seats total (5 showtimes * 25 seats each)'
    );
  }

  @isTest
  static void testSeatTypeAssignment() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    Test.stopTest();

    // Verify seat type assignment
    Integer vipSeats = 0;
    Integer wheelchairSeats = 0;
    Integer standardSeats = 0;

    for (Seat__c seat : seats) {
      if (seat.Seat_Type__c == 'VIP') {
        vipSeats++;
      } else if (seat.Seat_Type__c == 'Wheelchair') {
        wheelchairSeats++;
      } else if (seat.Seat_Type__c == 'Standard') {
        standardSeats++;
      }
    }

    System.assertEquals(
      10,
      vipSeats,
      'Should have 10 VIP seats (first 2 rows)'
    );
    System.assertEquals(
      2,
      wheelchairSeats,
      'Should have 2 wheelchair seats (last row corners)'
    );
    System.assertEquals(13, standardSeats, 'Should have 13 standard seats');
  }

  @isTest
  static void testErrorHandlingPatterns() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();

    // Test exception handling in generateSeats
    try {
      SeatManagementService.generateSeats(showtime.Id, 0, 0);
      System.assert(false, 'Should have handled zero parameters gracefully');
    } catch (Exception e) {
      System.assert(true, 'Expected exception handling');
    }

    // Test exception handling in lockSeats
    try {
      SeatManagementService.lockSeats(new List<Id>(), 5);
      System.assert(false, 'Should have handled empty list gracefully');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();
  }

  @isTest
  static void testGenerateSeatsDebug() {
    // Create test data without @TestSetup
    Movie__c movie = new Movie__c(
      Name = 'Test Movie Debug',
      Movie_API_ID__c = 'test123debug',
      Is_Active__c = true
    );
    insert movie;

    Theater__c theater = new Theater__c(
      Name = 'Test Theater Debug',
      Theater_API_ID__c = 'theater123debug',
      City__c = 'Test City',
      Is_Active__c = true
    );
    insert theater;

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(14, 30, 0, 0),
      Total_Seats__c = 100,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 15.00,
      Status__c = 'Scheduled'
    );

    // Bypass trigger to avoid automatic seat generation
    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');

    Test.startTest();

    // Check if seats exist before calling generateSeats
    Integer existingCount = [
      SELECT COUNT()
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
    ];
    System.debug('Existing seats count before generateSeats: ' + existingCount);

    // Call generateSeats
    List<Seat__c> seats = SeatManagementService.generateSeats(showtime.Id);
    System.debug('Seats returned by generateSeats: ' + seats.size());

    // Check if seats exist after calling generateSeats
    Integer afterCount = [
      SELECT COUNT()
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
    ];
    System.debug('Existing seats count after generateSeats: ' + afterCount);

    Test.stopTest();

    System.assert(!seats.isEmpty(), 'Seats should be created');
    System.assertEquals(100, seats.size(), 'Should create 100 seats (10x10)');
  }
}

```

```apex
/**
 * @description Test class for SeatManagementService following Context7 Apex Recipes patterns
 * @author Cristiano Filho
 * @date 2025-09-30
 */
@isTest
private class SeatManagementServiceTest {
  @TestSetup
  static void setupTestData() {
    Movie__c movie = new Movie__c(
      Name = 'Test Movie',
      Movie_API_ID__c = 'test123',
      Is_Active__c = true
    );
    insert movie;

    Theater__c theater = new Theater__c(
      Name = 'Test Theater',
      Theater_API_ID__c = 'theater123',
      City__c = 'Test City',
      Is_Active__c = true
    );
    insert theater;

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(14, 30, 0, 0),
      Total_Seats__c = 100,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 15.00,
      Status__c = 'Scheduled'
    );

    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');
  }

  private static Showtime__c createShowtime(Integer rows, Integer seatsPerRow) {
    Movie__c movie = [SELECT Id FROM Movie__c LIMIT 1];
    Theater__c theater = [SELECT Id FROM Theater__c LIMIT 1];

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(17, 0, 0, 0),
      Total_Seats__c = rows * seatsPerRow,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 18.00,
      Status__c = 'Scheduled'
    );

    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');
    return showtime;
  }

  @isTest
  static void testGenerateSeatsSimple() {
    Showtime__c showtime = createShowtime(5, 5);

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    Test.stopTest();

    System.assertEquals(25, seats.size(), 'Should create 25 seats (5x5)');

    List<Seat__c> createdSeats = [
      SELECT Row__c, Number__c, Seat_Type__c
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      ORDER BY Row__c, Number__c
    ];
    System.assertEquals(
      25,
      createdSeats.size(),
      'Should have 25 seats in database'
    );
    System.assertEquals(
      'A',
      createdSeats[0].Row__c,
      'First seat should be row A'
    );
    System.assertEquals(
      1,
      createdSeats[0].Number__c,
      'First seat should be number 1'
    );
    System.assertEquals(
      'VIP',
      createdSeats[0].Seat_Type__c,
      'Front row should be VIP'
    );
  }

  @isTest
  static void testGenerateSeatsCustomSize() {
    Showtime__c showtime = createShowtime(5, 10);

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      10
    );
    Test.stopTest();

    System.assertEquals(50, seats.size(), 'Should create 50 seats (5x10)');
  }

  @isTest
  static void testGenerateSeatsAlreadyExists() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    SeatManagementService.generateSeats(showtime.Id, 10, 10);

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      10,
      10
    );
    Test.stopTest();

    System.assertEquals(0, seats.size(), 'Should not create duplicate seats');
  }

  @isTest
  static void testLockSeats() {
    Showtime__c showtime = createShowtime(3, 5);
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      3,
      5
    );

    System.assert(!seats.isEmpty(), 'Seats should be created');

    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id, seats[2].Id };

    Test.startTest();
    SeatManagementService.lockSeats(seatIds, 5);
    Test.stopTest();

    List<Seat__c> lockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : lockedSeats) {
      System.assertEquals('Blocked', seat.Status__c, 'Seat should be blocked');
    }
  }

  @isTest
  static void testUnlockSeats() {
    Showtime__c showtime = createShowtime(3, 5);
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      3,
      5
    );
    System.assert(!seats.isEmpty(), 'Seats should be created');

    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id };
    SeatManagementService.lockSeats(seatIds, 5);

    Test.startTest();
    SeatManagementService.unlockSeats(seatIds);
    Test.stopTest();

    List<Seat__c> unlockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : unlockedSeats) {
      System.assertEquals(
        'Available',
        seat.Status__c,
        'Seat should be available'
      );
    }
  }

  @isTest
  static void testGetSeatStatistics() {
    Showtime__c showtime = createShowtime(5, 5);
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    System.assert(!seats.isEmpty(), 'Seats should be created');

    seats[0].Status__c = 'Reserved';
    seats[1].Status__c = 'Reserved';
    seats[2].Status__c = 'Blocked';
    update new List<Seat__c>{ seats[0], seats[1], seats[2] };

    Test.startTest();
    Map<String, Integer> stats = SeatManagementService.getSeatStatistics(
      showtime.Id
    );
    Test.stopTest();

    System.assertEquals(
      25,
      stats.get('total'),
      'Total should match generated seats'
    );
    System.assertEquals(
      22,
      stats.get('available'),
      'Available should reflect updates'
    );
    System.assertEquals(
      2,
      stats.get('reserved'),
      'Should count reserved seats'
    );
    System.assertEquals(1, stats.get('blocked'), 'Should count blocked seats');
  }

  // Context7 Apex Recipes Patterns Implementation

  @isTest
  static void testGenerateSeatsWithFLSValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    Test.stopTest();

    System.assertEquals(25, seats.size(), 'Should create 25 seats (5x5)');

    // Verify FLS validation worked
    System.assert(
      Schema.sObjectType.Seat__c.isCreateable(),
      'Seat__c should be createable'
    );
    System.assert(
      Schema.sObjectType.Seat__c.fields.Status__c.isCreateable(),
      'Status__c field should be createable'
    );
  }

  @isTest
  static void testGenerateSeatsWithCircuitBreaker() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    // Activate circuit breaker
    SeatManagementService.testCircuitBreaker = true;

    Test.startTest();
    try {
      SeatManagementService.generateSeats(showtime.Id, 5, 5);
      System.assert(
        false,
        'Should have thrown exception due to circuit breaker'
      );
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Circuit breaker activated'),
        'Should throw circuit breaker exception'
      );
      System.assert(
        SeatManagementService.circuitBreakerThrown,
        'Circuit breaker should be thrown'
      );
    }
    Test.stopTest();

    // Reset circuit breaker
    SeatManagementService.testCircuitBreaker = false;
    SeatManagementService.circuitBreakerThrown = false;
  }

  @isTest
  static void testGenerateSeatsWithInvalidParameters() {
    Showtime__c showtime = createShowtime(3, 5);

    Test.startTest();

    // Test with invalid parameters
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      -5,
      -5
    );
    Test.stopTest();

    System.assertEquals(
      100,
      seats.size(),
      'Should default to 10x10 seats when parameters invalid'
    );

    // Test with null showtime ID
    try {
      SeatManagementService.generateSeats(null, 5, 5);
      System.assert(false, 'Should have thrown exception for null showtime ID');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Failed to generate seats'),
        'Should wrap exception when showtime is null'
      );
    }
  }

  @isTest
  static void testLockSeatsWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id };

    Test.startTest();

    // Test with valid parameters
    SeatManagementService.lockSeats(seatIds, 5);

    // Test with invalid parameters
    try {
      SeatManagementService.lockSeats(null, 5);
      System.assert(false, 'Should have thrown exception for null seat IDs');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    try {
      SeatManagementService.lockSeats(seatIds, -5);
      System.assert(
        false,
        'Should have thrown exception for negative duration'
      );
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Duration must be a positive number'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();

    // Verify seats were locked
    List<Seat__c> lockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : lockedSeats) {
      System.assertEquals('Blocked', seat.Status__c, 'Seat should be blocked');
    }
  }

  @isTest
  static void testUnlockSeatsWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id };

    // Lock seats first
    SeatManagementService.lockSeats(seatIds, 5);

    Test.startTest();

    // Test with valid parameters
    SeatManagementService.unlockSeats(seatIds);

    // Test with invalid parameters
    try {
      SeatManagementService.unlockSeats(null);
      System.assert(false, 'Should have thrown exception for null seat IDs');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();

    // Verify seats were unlocked
    List<Seat__c> unlockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : unlockedSeats) {
      System.assertEquals(
        'Available',
        seat.Status__c,
        'Seat should be available'
      );
    }
  }

  @isTest
  static void testGetSeatStatisticsWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );

    Test.startTest();

    // Test with valid showtime ID
    Map<String, Integer> stats = SeatManagementService.getSeatStatistics(
      showtime.Id
    );
    System.assertEquals(25, stats.get('total'), 'Total should be 25');
    System.assertEquals(25, stats.get('available'), 'Should have 25 available');

    // Test with null showtime ID
    Map<String, Integer> nullStats = SeatManagementService.getSeatStatistics(
      null
    );
    System.assertEquals(
      0,
      nullStats.get('total'),
      'Should return empty stats for null ID'
    );

    Test.stopTest();
  }

  @isTest
  static void testBulkOperations() {
    Showtime__c baseShowtime = [
      SELECT Id, Session_Date__c
      FROM Showtime__c
      LIMIT 1
    ];

    List<Showtime__c> showtimes = new List<Showtime__c>();
    for (Integer i = 0; i < 5; i++) {
      showtimes.add(createShowtime(5, 5));
    }

    Test.startTest();
    Integer totalSeats = 0;
    for (Showtime__c st : showtimes) {
      totalSeats += SeatManagementService.generateSeats(st.Id, 5, 5).size();
    }
    Test.stopTest();

    System.assertEquals(
      125,
      totalSeats,
      'Should create 125 seats total (5 showtimes * 25 seats each)'
    );
  }

  @isTest
  static void testSeatTypeAssignment() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    Test.stopTest();

    // Verify seat type assignment
    Integer vipSeats = 0;
    Integer wheelchairSeats = 0;
    Integer standardSeats = 0;

    for (Seat__c seat : seats) {
      if (seat.Seat_Type__c == 'VIP') {
        vipSeats++;
      } else if (seat.Seat_Type__c == 'Wheelchair') {
        wheelchairSeats++;
      } else if (seat.Seat_Type__c == 'Standard') {
        standardSeats++;
      }
    }

    System.assertEquals(
      10,
      vipSeats,
      'Should have 10 VIP seats (first 2 rows)'
    );
    System.assertEquals(
      2,
      wheelchairSeats,
      'Should have 2 wheelchair seats (last row corners)'
    );
    System.assertEquals(13, standardSeats, 'Should have 13 standard seats');
  }

  @isTest
  static void testErrorHandlingPatterns() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();

    // Test exception handling in generateSeats
    try {
      SeatManagementService.generateSeats(showtime.Id, 0, 0);
      System.assert(false, 'Should have handled zero parameters gracefully');
    } catch (Exception e) {
      System.assert(true, 'Expected exception handling');
    }

    // Test exception handling in lockSeats
    try {
      SeatManagementService.lockSeats(new List<Id>(), 5);
      System.assert(false, 'Should have handled empty list gracefully');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();
  }

  @isTest
  static void testGenerateSeatsDebug() {
    // Create test data without @TestSetup
    Movie__c movie = new Movie__c(
      Name = 'Test Movie Debug',
      Movie_API_ID__c = 'test123debug',
      Is_Active__c = true
    );
    insert movie;

    Theater__c theater = new Theater__c(
      Name = 'Test Theater Debug',
      Theater_API_ID__c = 'theater123debug',
      City__c = 'Test City',
      Is_Active__c = true
    );
    insert theater;

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(14, 30, 0, 0),
      Total_Seats__c = 100,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 15.00,
      Status__c = 'Scheduled'
    );

    // Bypass trigger to avoid automatic seat generation
    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');

    Test.startTest();

    // Check if seats exist before calling generateSeats
    Integer existingCount = [
      SELECT COUNT()
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
    ];
    System.debug('Existing seats count before generateSeats: ' + existingCount);

    // Call generateSeats
    List<Seat__c> seats = SeatManagementService.generateSeats(showtime.Id);
    System.debug('Seats returned by generateSeats: ' + seats.size());

    // Check if seats exist after calling generateSeats
    Integer afterCount = [
      SELECT COUNT()
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
    ];
    System.debug('Existing seats count after generateSeats: ' + afterCount);

    Test.stopTest();

    System.assert(!seats.isEmpty(), 'Seats should be created');
    System.assertEquals(100, seats.size(), 'Should create 100 seats (10x10)');
  }
}

```

```apex
/**
 * @description Test class for SeatManagementService following Context7 Apex Recipes patterns
 * @author Cristiano Filho
 * @date 2025-09-30
 */
@isTest
private class SeatManagementServiceTest {
  @TestSetup
  static void setupTestData() {
    Movie__c movie = new Movie__c(
      Name = 'Test Movie',
      Movie_API_ID__c = 'test123',
      Is_Active__c = true
    );
    insert movie;

    Theater__c theater = new Theater__c(
      Name = 'Test Theater',
      Theater_API_ID__c = 'theater123',
      City__c = 'Test City',
      Is_Active__c = true
    );
    insert theater;

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(14, 30, 0, 0),
      Total_Seats__c = 100,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 15.00,
      Status__c = 'Scheduled'
    );

    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');
  }

  private static Showtime__c createShowtime(Integer rows, Integer seatsPerRow) {
    Movie__c movie = [SELECT Id FROM Movie__c LIMIT 1];
    Theater__c theater = [SELECT Id FROM Theater__c LIMIT 1];

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(17, 0, 0, 0),
      Total_Seats__c = rows * seatsPerRow,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 18.00,
      Status__c = 'Scheduled'
    );

    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');
    return showtime;
  }

  @isTest
  static void testGenerateSeatsSimple() {
    Showtime__c showtime = createShowtime(5, 5);

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    Test.stopTest();

    System.assertEquals(25, seats.size(), 'Should create 25 seats (5x5)');

    List<Seat__c> createdSeats = [
      SELECT Row__c, Number__c, Seat_Type__c
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
      ORDER BY Row__c, Number__c
    ];
    System.assertEquals(
      25,
      createdSeats.size(),
      'Should have 25 seats in database'
    );
    System.assertEquals(
      'A',
      createdSeats[0].Row__c,
      'First seat should be row A'
    );
    System.assertEquals(
      1,
      createdSeats[0].Number__c,
      'First seat should be number 1'
    );
    System.assertEquals(
      'VIP',
      createdSeats[0].Seat_Type__c,
      'Front row should be VIP'
    );
  }

  @isTest
  static void testGenerateSeatsCustomSize() {
    Showtime__c showtime = createShowtime(5, 10);

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      10
    );
    Test.stopTest();

    System.assertEquals(50, seats.size(), 'Should create 50 seats (5x10)');
  }

  @isTest
  static void testGenerateSeatsAlreadyExists() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    SeatManagementService.generateSeats(showtime.Id, 10, 10);

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      10,
      10
    );
    Test.stopTest();

    System.assertEquals(0, seats.size(), 'Should not create duplicate seats');
  }

  @isTest
  static void testLockSeats() {
    Showtime__c showtime = createShowtime(3, 5);
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      3,
      5
    );

    System.assert(!seats.isEmpty(), 'Seats should be created');

    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id, seats[2].Id };

    Test.startTest();
    SeatManagementService.lockSeats(seatIds, 5);
    Test.stopTest();

    List<Seat__c> lockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : lockedSeats) {
      System.assertEquals('Blocked', seat.Status__c, 'Seat should be blocked');
    }
  }

  @isTest
  static void testUnlockSeats() {
    Showtime__c showtime = createShowtime(3, 5);
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      3,
      5
    );
    System.assert(!seats.isEmpty(), 'Seats should be created');

    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id };
    SeatManagementService.lockSeats(seatIds, 5);

    Test.startTest();
    SeatManagementService.unlockSeats(seatIds);
    Test.stopTest();

    List<Seat__c> unlockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : unlockedSeats) {
      System.assertEquals(
        'Available',
        seat.Status__c,
        'Seat should be available'
      );
    }
  }

  @isTest
  static void testGetSeatStatistics() {
    Showtime__c showtime = createShowtime(5, 5);
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    System.assert(!seats.isEmpty(), 'Seats should be created');

    seats[0].Status__c = 'Reserved';
    seats[1].Status__c = 'Reserved';
    seats[2].Status__c = 'Blocked';
    update new List<Seat__c>{ seats[0], seats[1], seats[2] };

    Test.startTest();
    Map<String, Integer> stats = SeatManagementService.getSeatStatistics(
      showtime.Id
    );
    Test.stopTest();

    System.assertEquals(
      25,
      stats.get('total'),
      'Total should match generated seats'
    );
    System.assertEquals(
      22,
      stats.get('available'),
      'Available should reflect updates'
    );
    System.assertEquals(
      2,
      stats.get('reserved'),
      'Should count reserved seats'
    );
    System.assertEquals(1, stats.get('blocked'), 'Should count blocked seats');
  }

  // Context7 Apex Recipes Patterns Implementation

  @isTest
  static void testGenerateSeatsWithFLSValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    Test.stopTest();

    System.assertEquals(25, seats.size(), 'Should create 25 seats (5x5)');

    // Verify FLS validation worked
    System.assert(
      Schema.sObjectType.Seat__c.isCreateable(),
      'Seat__c should be createable'
    );
    System.assert(
      Schema.sObjectType.Seat__c.fields.Status__c.isCreateable(),
      'Status__c field should be createable'
    );
  }

  @isTest
  static void testGenerateSeatsWithCircuitBreaker() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    // Activate circuit breaker
    SeatManagementService.testCircuitBreaker = true;

    Test.startTest();
    try {
      SeatManagementService.generateSeats(showtime.Id, 5, 5);
      System.assert(
        false,
        'Should have thrown exception due to circuit breaker'
      );
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Circuit breaker activated'),
        'Should throw circuit breaker exception'
      );
      System.assert(
        SeatManagementService.circuitBreakerThrown,
        'Circuit breaker should be thrown'
      );
    }
    Test.stopTest();

    // Reset circuit breaker
    SeatManagementService.testCircuitBreaker = false;
    SeatManagementService.circuitBreakerThrown = false;
  }

  @isTest
  static void testGenerateSeatsWithInvalidParameters() {
    Showtime__c showtime = createShowtime(3, 5);

    Test.startTest();

    // Test with invalid parameters
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      -5,
      -5
    );
    Test.stopTest();

    System.assertEquals(
      100,
      seats.size(),
      'Should default to 10x10 seats when parameters invalid'
    );

    // Test with null showtime ID
    try {
      SeatManagementService.generateSeats(null, 5, 5);
      System.assert(false, 'Should have thrown exception for null showtime ID');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Showtime ID cannot be null'),
        'Should report missing showtime'
      );
    }
  }

  @isTest
  static void testLockSeatsWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id };

    Test.startTest();

    // Test with valid parameters
    SeatManagementService.lockSeats(seatIds, 5);

    // Test with invalid parameters
    try {
      SeatManagementService.lockSeats(null, 5);
      System.assert(false, 'Should have thrown exception for null seat IDs');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    try {
      SeatManagementService.lockSeats(seatIds, -5);
      System.assert(
        false,
        'Should have thrown exception for negative duration'
      );
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Duration must be a positive number'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();

    // Verify seats were locked
    List<Seat__c> lockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : lockedSeats) {
      System.assertEquals('Blocked', seat.Status__c, 'Seat should be blocked');
    }
  }

  @isTest
  static void testUnlockSeatsWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    List<Id> seatIds = new List<Id>{ seats[0].Id, seats[1].Id };

    // Lock seats first
    SeatManagementService.lockSeats(seatIds, 5);

    Test.startTest();

    // Test with valid parameters
    SeatManagementService.unlockSeats(seatIds);

    // Test with invalid parameters
    try {
      SeatManagementService.unlockSeats(null);
      System.assert(false, 'Should have thrown exception for null seat IDs');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();

    // Verify seats were unlocked
    List<Seat__c> unlockedSeats = [
      SELECT Status__c
      FROM Seat__c
      WHERE Id IN :seatIds
    ];
    for (Seat__c seat : unlockedSeats) {
      System.assertEquals(
        'Available',
        seat.Status__c,
        'Seat should be available'
      );
    }
  }

  @isTest
  static void testGetSeatStatisticsWithValidation() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );

    Test.startTest();

    // Test with valid showtime ID
    Map<String, Integer> stats = SeatManagementService.getSeatStatistics(
      showtime.Id
    );
    System.assertEquals(25, stats.get('total'), 'Total should be 25');
    System.assertEquals(25, stats.get('available'), 'Should have 25 available');

    // Test with null showtime ID
    Map<String, Integer> nullStats = SeatManagementService.getSeatStatistics(
      null
    );
    System.assertEquals(
      0,
      nullStats.get('total'),
      'Should return empty stats for null ID'
    );

    Test.stopTest();
  }

  @isTest
  static void testBulkOperations() {
    Showtime__c baseShowtime = [
      SELECT Id, Session_Date__c
      FROM Showtime__c
      LIMIT 1
    ];

    List<Showtime__c> showtimes = new List<Showtime__c>();
    for (Integer i = 0; i < 5; i++) {
      showtimes.add(createShowtime(5, 5));
    }

    Test.startTest();
    Integer totalSeats = 0;
    for (Showtime__c st : showtimes) {
      totalSeats += SeatManagementService.generateSeats(st.Id, 5, 5).size();
    }
    Test.stopTest();

    System.assertEquals(
      125,
      totalSeats,
      'Should create 125 seats total (5 showtimes * 25 seats each)'
    );
  }

  @isTest
  static void testSeatTypeAssignment() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();
    List<Seat__c> seats = SeatManagementService.generateSeats(
      showtime.Id,
      5,
      5
    );
    Test.stopTest();

    // Verify seat type assignment
    Integer vipSeats = 0;
    Integer wheelchairSeats = 0;
    Integer standardSeats = 0;

    for (Seat__c seat : seats) {
      if (seat.Seat_Type__c == 'VIP') {
        vipSeats++;
      } else if (seat.Seat_Type__c == 'Wheelchair') {
        wheelchairSeats++;
      } else if (seat.Seat_Type__c == 'Standard') {
        standardSeats++;
      }
    }

    System.assertEquals(
      10,
      vipSeats,
      'Should have 10 VIP seats (first 2 rows)'
    );
    System.assertEquals(
      2,
      wheelchairSeats,
      'Should have 2 wheelchair seats (last row corners)'
    );
    System.assertEquals(13, standardSeats, 'Should have 13 standard seats');
  }

  @isTest
  static void testErrorHandlingPatterns() {
    Showtime__c showtime = [SELECT Id FROM Showtime__c LIMIT 1];

    Test.startTest();

    // Test exception handling in generateSeats
    try {
      SeatManagementService.generateSeats(showtime.Id, 0, 0);
      System.assert(false, 'Should have handled zero parameters gracefully');
    } catch (Exception e) {
      System.assert(true, 'Expected exception handling');
    }

    // Test exception handling in lockSeats
    try {
      SeatManagementService.lockSeats(new List<Id>(), 5);
      System.assert(false, 'Should have handled empty list gracefully');
    } catch (SeatManagementService.SeatManagementException e) {
      System.assert(
        e.getMessage().contains('Seat IDs cannot be null'),
        'Should throw appropriate exception'
      );
    }

    Test.stopTest();
  }

  @isTest
  static void testGenerateSeatsDebug() {
    // Create test data without @TestSetup
    Movie__c movie = new Movie__c(
      Name = 'Test Movie Debug',
      Movie_API_ID__c = 'test123debug',
      Is_Active__c = true
    );
    insert movie;

    Theater__c theater = new Theater__c(
      Name = 'Test Theater Debug',
      Theater_API_ID__c = 'theater123debug',
      City__c = 'Test City',
      Is_Active__c = true
    );
    insert theater;

    Showtime__c showtime = new Showtime__c(
      Movie__c = movie.Id,
      Theater__c = theater.Id,
      Session_Date__c = Date.today().addDays(1),
      Session_Time__c = Time.newInstance(14, 30, 0, 0),
      Total_Seats__c = 100,
      Reserved_Seats__c = 0,
      Ticket_Price__c = 15.00,
      Status__c = 'Scheduled'
    );

    // Bypass trigger to avoid automatic seat generation
    TriggerHandler.bypass('ShowtimeTriggerHandler');
    insert showtime;
    TriggerHandler.clearBypass('ShowtimeTriggerHandler');

    Test.startTest();

    // Check if seats exist before calling generateSeats
    Integer existingCount = [
      SELECT COUNT()
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
    ];
    System.debug('Existing seats count before generateSeats: ' + existingCount);

    // Call generateSeats
    List<Seat__c> seats = SeatManagementService.generateSeats(showtime.Id);
    System.debug('Seats returned by generateSeats: ' + seats.size());

    // Check if seats exist after calling generateSeats
    Integer afterCount = [
      SELECT COUNT()
      FROM Seat__c
      WHERE Showtime__c = :showtime.Id
    ];
    System.debug('Existing seats count after generateSeats: ' + afterCount);

    Test.stopTest();

    System.assert(!seats.isEmpty(), 'Seats should be created');
    System.assertEquals(100, seats.size(), 'Should create 100 seats (10x10)');
  }
}

```

- Added richer PaymentService tests: refactored `createConfirmedReservation` to handle overrides, added gateway failure coverage, and broadened validation (`PaymentServiceTest.cls`).
- Expanded ReservationController coverage: ensured pre-payment status check and added end-to-end `createReservationWithPayment` success scenario validating seat updates (`ReservationControllerTest.cls`).
- Tightened SeatManagementService tests: assert specific exception text for null showtime branch (`SeatManagementServiceTest.cls`).
- Redeployed latest changes to `DeveloperEdition`; deployment succeeded.

Next steps: rerun Apex tests with coverage (target ≥75%), address remaining low-coverage areas, then proceed with data import/E2E tasks.

---

**User**

agora gere o .gitignore e continuamos amanhã 

---

**Cursor**

```ignore
# Node / JavaScript
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Salesforce DX / CLI
.sfdx/
.sf/
.localdevserver/
*.log

# Environment / Secrets
.env*
*.key
*.crt

# Playwright artifacts
playwright-report/
test-results/
playwright-results.json

# Coverage / Reports
coverage/
reports/**/*.json
reports/**/*.zip

# OS / Editor junk
.DS_Store
Thumbs.db
*.swp
.idea/
.vscode/

# Salesforce cache
.sf/
.sfdx/
.localdevserver/
deploy-options.json

# LWC VSCode autocomplete
**/lwc/jsconfig.json

# LWC Jest coverage reports
coverage/

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Dependency directories
node_modules/

# Eslint cache
.eslintcache

# MacOS system files
.DS_Store

# Windows system files
Thumbs.db
ehthumbs.db
[Dd]esktop.ini
$RECYCLE.BIN/

# Local environment variables
.env
.env.local

# Python Salesforce DX
**/__pycache__/
**/*.pyc

# Apex Log
**/*.log-meta.xml

# Visual Studio Code
.vscode/
!.vscode/extensions.json
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json

# JetBrains IDEs
.idea/
*.iml

# Scratch Org Definitions
.scratch-orgs/

# Config files with sensitive data
**/connectedApps/*.connectedApp
**/namedCredentials/*.namedCredential

# Test results
test-results/
/test-result-*.json

# PMD cache
.pmd/

# Backup files
*.bak
*.backup
*~

# github 
.github/

```

I generated a `.gitignore` tailored for the project. Let me know when you're ready to resume tomorrow.

